<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess Game Analyzer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background-color: #121212;
        color: #f0f0f0;
    }
    table {
        border-collapse: collapse;
        margin-top: 20px;
        width: 100%;
    }
    td, th {
        border: 1px solid #444;
        padding: 8px;
    }
    button {
        margin-top: 10px;
        padding: 5px 10px;
        cursor: pointer;
        background-color: #333;
        color: #f0f0f0;
        border: 1px solid #555;
        border-radius: 4px;
    }
    input {
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #555;
        background-color: #222;
        color: #f0f0f0;
    }
    h1, h2, h3 {
        margin-top: 20px;
    }
    pre {
        background-color: #1e1e1e;
        padding: 10px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        border-radius: 6px;
    }
    #analysis > div {
        margin-bottom: 20px;
    }
    #inputRow {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }
    #inputRow label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    #chessboard {
        width: 320px;
        margin-top: 20px;
    }
</style>
</head>
<body>
<h1>Chess Game Analyzer</h1>

<div id="inputRow">
    <label>
        <img src="https://upload.wikimedia.org/wikipedia/commons/3/3b/Chess_com_logo.svg" 
             alt="Chess.com" width="24" height="24" />
        Chess.com Username:
        <input type="text" id="username" />
    </label>
    <button id="fetchBtn" onclick="fetchGames()">Fetch Last 10 Games</button>
    <button id="analyzeBtn" onclick="analyzeAll()" style="display:none;">Analyze All Games</button>
</div>

<!-- Dynamic Chessboard -->
<div id="chessboard"></div>

<table id="gamesTable" style="display:none">
    <thead>
        <tr><th>White</th><th>Black</th><th>Result</th></tr>
    </thead>
    <tbody></tbody>
</table>

<h2>LLM Analysis (All Games)</h2>
<div id="analysis"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script>
let board = null;
let game = null;

document.addEventListener("DOMContentLoaded", () => {
    game = new Chess();  // Initialize empty chess game
    board = Chessboard('chessboard', {
        position: 'start',
        showNotation: true,
        draggable: true,
        dropOffBoard: 'trash',
        sparePieces: false
    });
});

async function fetchGames() {
    const username = document.getElementById("username").value;
    if (!username) return alert("Enter a username");

    const res = await fetch(`/api/games/${username}`);
    const games = await res.json();

    if (!games || games.length === 0) return alert("No games found");

    const tbody = document.querySelector("#gamesTable tbody");
    tbody.innerHTML = "";
    games.forEach(g => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${g.white}</td>
            <td>${g.black}</td>
            <td>${g.result}</td>
        `;
        tbody.appendChild(tr);
    });

    window.gameData = games;  // store globally
    document.getElementById("gamesTable").style.display = "table";

    // Show the Analyze button now that games are fetched
    document.getElementById("analyzeBtn").style.display = "inline-block";
}

async function analyzeAll() {
    if (!window.gameData || window.gameData.length === 0) return alert("Fetch games first!");

    const username = document.getElementById("username").value;
    const pgns = window.gameData.map(g => g.pgn);

    const analysisDiv = document.getElementById("analysis");
    analysisDiv.innerHTML = `<p>Analyzing games, please wait...</p>`;

    try {
        const res = await fetch("/api/analyze-all", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, pgns })
        });

        const data = await res.json();
        let ta = data.textual_analysis;

        function cleanLLMText(text) {
            if (!text) return "";
            return text
                .replace(/^["']|["']$/g, '')
                .replace(/\\n/g, '\n')
                .replace(/\\r/g, '')
                .replace(/\\"/g, '"');
        }
        
        analysisDiv.innerHTML = `
            <div>
                <h3>Opening</h3>
                <pre>${cleanLLMText(ta.openings)}</pre>
            </div>
            <div>
                <h3>Middle Game</h3>
                <pre>${cleanLLMText(ta.middlegame)}</pre>
            </div>
            <div>
                <h3>Endgame</h3>
                <pre>${cleanLLMText(ta.endgame)}</pre>
            </div>
        `;

        // Reset the board to start
        game.reset();
        board.position(game.fen());

    } catch (err) {
        analysisDiv.innerHTML = `<p style="color:red;">Error analyzing games: ${err}</p>`;
    }
}
</script>
</body>
</html>
