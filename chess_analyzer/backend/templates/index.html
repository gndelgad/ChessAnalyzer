<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess Game Analyzer</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background-color: #0b1c3d; /* deep blue */
        color: #f0f0f0;
    }
    table {
        border-collapse: collapse;
        margin-top: 20px;
        width: 100%;
    }
    td, th {
        border: 1px solid #444;
        padding: 8px;
    }
    button {
        margin-top: 10px;
        padding: 5px 10px;
        cursor: pointer;
        background-color: #333;
        color: #f0f0f0;
        border: 1px solid #555;
        border-radius: 4px;
    }
    input {
        padding: 4px 6px;
        border-radius: 4px;
        border: 1px solid #555;
        background-color: #222;
        color: #f0f0f0;
    }
    h1, h2, h3 {
        margin-top: 20px;
    }
    pre {
        background-color: #1e1e1e;
        padding: 10px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        border-radius: 6px;
    }
    #analysis > div {
        margin-bottom: 20px;
    }
    #inputRow {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }
    #inputRow label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
</style>
</head>

<body>
<h1>Chess Game Analyzer</h1>

<div id="inputRow">
    <label>
        Chess.com Username:
        <input type="text" id="username" />
    </label>
    <button id="fetchBtn" onclick="fetchGames()">Fetch Last 10 Games</button>
</div>

<table id="gamesTable" style="display:none">
    <thead>
        <tr>
            <th>White</th>
            <th>Black</th>
            <th>Result</th>
            <th>Accuracy</th>
            <th>Blunders</th>
            <th>URL</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Analyze button now appears BELOW the games matrix -->
<button id="analyzeBtn" onclick="analyzeAll()" style="display:none;">
    Analyze All Games
</button>

<h2>LLM Analysis (All Games)</h2>
<div id="analysis"></div>

<script>
async function fetchGames() {
    const username = document.getElementById("username").value;
    if (!username) return alert("Enter a username");

    const res = await fetch(`/api/games/${username}`);
    const games = await res.json();

    if (!games || games.length === 0) return alert("No games found");

    const tbody = document.querySelector("#gamesTable tbody");
    tbody.innerHTML = "";
    games.forEach(g => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${g.white}</td>
            <td>${g.black}</td>
            <td>${g.result}</td>
            <td>${g.accuracy}</td>
            <td>${g.blunders}</td>
            <td>${g.url}</td>
        `;
        tbody.appendChild(tr);
    });

    window.gameData = games;
    document.getElementById("gamesTable").style.display = "table";

    // Show Analyze button now (logic unchanged)
    document.getElementById("analyzeBtn").style.display = "inline-block";
}

async function analyzeAll() {
    if (!window.gameData || window.gameData.length === 0)
        return alert("Fetch games first!");

    const username = document.getElementById("username").value;
    const pgns = window.gameData.map(g => g.pgn);

    const analysisDiv = document.getElementById("analysis");
    analysisDiv.innerHTML = `<p>Analyzing games, please wait...</p>`;

    try {
        const res = await fetch("/api/analyze-all", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, pgns })
        });

        const data = await res.json();
        let ta = data.textual_analysis;

        if (typeof ta === "string") {
            ta = ta.trim().replace(/^```json\s*/, '').replace(/```$/, '');
            try { ta = JSON.parse(ta); }
            catch {
                ta = { openings: ta, middlegame: ta, endgame: ta };
            }
        }

        analysisDiv.innerHTML = `
            <div>
                <h3>Opening</h3>
                <pre>${ta.openings || "No data"}</pre>
            </div>
            <div>
                <h3>Middle Game</h3>
                <pre>${ta.middlegame || "No data"}</pre>
            </div>
            <div>
                <h3>Endgame</h3>
                <pre>${ta.endgame || "No data"}</pre>
            </div>
        `;
    } catch (err) {
        analysisDiv.innerHTML =
            `<p style="color:red;">Error analyzing games: ${err}</p>`;
    }
}
</script>
</body>
</html>
